# Файлы для Supabase

Этот документ описывает все SQL файлы, которые были созданы для настройки базы данных Supabase.

## Основные файлы схемы

### 1. `schema-working.sql` ⭐ **РЕКОМЕНДУЕТСЯ**
**Описание:** Рабочая схема базы данных с умной миграцией. Безопасно работает с существующими таблицами.

**Что делает:**
- Создает все необходимые таблицы (products, stock, stores, sales, purchases, и др.)
- Добавляет недостающие колонки в существующие таблицы
- Создает индексы и внешние ключи
- Добавляет триггеры для автоматического обновления `updated_at`
- Безопасно выполняется даже если таблицы уже существуют

**Когда использовать:** 
- При первой настройке базы данных
- Для обновления существующей схемы

**Как выполнить:**
1. Откройте SQL Editor в Supabase
2. Скопируйте содержимое файла
3. Выполните скрипт

---

### 2. `schema.sql`
**Описание:** Базовая схема базы данных (первая версия).

**Статус:** Устаревший, используйте `schema-working.sql`

---

### 3. `schema-complete.sql`
**Описание:** Полная схема со всеми таблицами.

**Статус:** Альтернатива `schema-working.sql`, но менее безопасная для миграций

---

### 4. `schema-final.sql`
**Описание:** Финальная версия схемы.

**Статус:** Альтернатива `schema-working.sql`

---

### 5. `schema-safe.sql`
**Описание:** Безопасная версия схемы с проверками.

**Статус:** Альтернатива `schema-working.sql`

---

### 6. `schema-step-by-step.sql`
**Описание:** Пошаговая схема для отладки.

**Статус:** Используется для отладки проблем с миграцией

---

## Миграции

### 7. `migration-add-store-to-stock.sql` ⚠️ **ВАЖНО**
**Описание:** Добавляет поддержку складов в таблице остатков.

**Что делает:**
- Добавляет колонку `store_id` в таблицу `stock`
- Создает индекс для `store_id`
- Обновляет уникальное ограничение для поддержки нескольких складов

**Когда использовать:**
- Если в таблице `stock` нет колонки `store_id`
- После синхронизации складов

**Статус:** **ТРЕБУЕТСЯ ВЫПОЛНЕНИЕ** (если еще не выполнено)

**Как выполнить:**
```sql
-- Скопируйте содержимое файла в SQL Editor Supabase
-- Или используйте команду:
npm run add-store-id-to-stock
```

---

### 8. `migration-add-sql-function.sql` ⚠️ **ВАЖНО**
**Описание:** Создает функцию для безопасного выполнения SQL запросов через AI чат.

**Что делает:**
- Создает функцию `execute_readonly_query` для выполнения SELECT запросов
- Добавляет проверки безопасности (только SELECT запросы)
- Предоставляет доступ для authenticated, anon и service_role

**Когда использовать:**
- Для работы SQL запросов через AI чат
- Если вы хотите выполнять SQL запросы через интерфейс

**Статус:** Опционально (не обязательно для базовой работы)

**Как выполнить:**
```bash
npm run install-sql-function
```
Или скопируйте содержимое файла в SQL Editor Supabase.

---

### 9. `migration-fix.sql`
**Описание:** Исправления для существующей схемы.

**Статус:** Используется для исправления конкретных проблем

---

## Вспомогательные файлы

### 10. `check-tables.sql`
**Описание:** Скрипт для проверки существования таблиц.

**Что делает:**
- Проверяет наличие всех необходимых таблиц
- Показывает список существующих таблиц

**Как использовать:**
```bash
npm run check-supabase
```

---

### 11. `verify-schema.sql`
**Описание:** Проверка корректности схемы базы данных.

**Статус:** Для отладки

---

### 12. `rls-policies.sql`
**Описание:** Политики Row Level Security (RLS) для безопасности данных.

**Что делает:**
- Настраивает RLS для таблиц
- Определяет права доступа

**Статус:** Опционально (для дополнительной безопасности)

---

### 13. `sql-function-execute-query.sql`
**Описание:** Старая версия функции для SQL запросов.

**Статус:** Устаревший, используйте `migration-add-sql-function.sql`

---

## Рекомендуемый порядок выполнения

### Для новой базы данных:

1. **Выполните основную схему:**
   ```sql
   -- Скопируйте и выполните schema-working.sql в SQL Editor
   ```

2. **Добавьте поддержку складов:**
   ```sql
   -- Выполните migration-add-store-to-stock.sql
   ```

3. **Опционально: добавьте SQL функцию:**
   ```bash
   npm run install-sql-function
   ```

### Для существующей базы данных:

1. **Проверьте текущее состояние:**
   ```bash
   npm run check-supabase
   ```

2. **Если нет колонки store_id в stock:**
   ```sql
   -- Выполните migration-add-store-to-stock.sql
   ```

3. **Если нужно обновить схему:**
   ```sql
   -- Выполните schema-working.sql (он безопасен для существующих таблиц)
   ```

---

## Проверка выполнения

После выполнения миграций проверьте статус:

```bash
npm run check-supabase
```

Это покажет:
- Какие таблицы существуют
- Сколько записей в каждой таблице
- Примеры данных

---

## Важные замечания

1. **Всегда делайте резервную копию** перед выполнением миграций
2. **schema-working.sql** - самый безопасный вариант для миграций
3. **migration-add-store-to-stock.sql** - обязательна для работы со складами
4. **migration-add-sql-function.sql** - опциональна, только для SQL запросов через AI

---

## Связь с документацией

- Подробная информация о схеме: `docs/API_MAPPING.md`
- Настройка SQL функции: `docs/SQL_SETUP.md`
- Инструкции по установке: `INSTALL_SQL_FUNCTION.md`

